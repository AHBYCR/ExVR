<!DOCTYPE html>
<html>
<head>
    <title>VR Controller - {{ hand|upper }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root {
            --primary-color: #2196F3;
            --button-size: 18vw; /* Use viewport width for button size */
        }

        body {
            margin: 0;
            padding: 0;
            background: #000;
            touch-action: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .joystick-container {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 2vh; /* Use viewport height for margin */
        }

        .joystick-area {
            position: relative;
            width: 55vw; /* Use viewport width for joystick area size */
            height: 55vw; /* Keep aspect ratio consistent */
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .joystick-thumb {
            width: 15vw; /* Use viewport width for thumb size */
            height: 15vw; /* Keep aspect ratio consistent */
            background: var(--primary-color);
            border-radius: 50%;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.1s, background 0.1s;
        }

        .joystick-thumb.active {
            background: red;
        }

        .button-grid {
            display: flex;
            gap: 4vw; /* Use viewport width for gap */
            justify-content: center;
        }

        .vr-button {
            width: var(--button-size);
            height: var(--button-size);
            border-radius: 50%;
            background: rgba(51, 51, 51, 0.5);
            border: 2px solid #666;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: background 0.1s, border-color 0.1s;
        }

        .vr-button.active {
            background: var(--primary-color);
            border-color: #fff;
        }

        .vr-button-label {
            position: absolute;
            bottom: -2vh; /* Use viewport height for label position */
            color: white;
            font-size: 2vh; /* Use viewport height for font size */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
        }

        .trigger {
            width: var(--button-size);
            height: var(--button-size);
            border-radius: 50%;
            background: rgba(51, 51, 51, 0.5);
            border: 2px solid #666;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.1s, border-color 0.1s;
            position: absolute;
        }

        .trigger.active {
            background: var(--primary-color);
            border-color: #fff;
        }

        .trigger-label {
            position: absolute;
            color: white;
            font-size: 2vh; /* Use viewport height for font size */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
        }

        .upper-trigger .trigger-label {
            top: -2vh; /* Use viewport height for label position */
            bottom: auto;
        }

        .lower-trigger .trigger-label {
            bottom: -2vh; /* Use viewport height for label position */
        }

        {% if hand == 'Right' %}
        .upper-trigger { right: -16vw; top: 50%; transform: translateY(-100%); }
        .lower-trigger { right: -16vw; top: 50%; transform: translateY(0); }
        {% else %}
        .upper-trigger { left: -16vw; top: 50%; transform: translateY(-100%); }
        .lower-trigger { left: -16vw; top: 50%; transform: translateY(0); }
        {% endif %}

        .cube-container {
            width: 24vw; /* Use viewport width for cube container size */
            height: 24vw; /* Keep aspect ratio consistent */
            perspective: 50vw; /* Use viewport width for perspective */
            margin-bottom: 2vh; /* Use viewport height for margin */
        }

        .cube {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg);
            transition: transform 0.1s linear;
        }

        .cube-face {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 3vh; /* Use viewport height for font size */
            font-weight: bold;
        }

        .cube-face.front { transform: translateZ(12vw); }
        .cube-face.back { transform: rotateY(180deg) translateZ(12vw); }
        .cube-face.left { transform: rotateY(-90deg) translateZ(12vw); }
        .cube-face.right { transform: rotateY(90deg) translateZ(12vw); }
        .cube-face.top { transform: rotateX(90deg) translateZ(12vw); }
        .cube-face.bottom { transform: rotateX(-90deg) translateZ(12vw); }
    </style>
</head>

<body>
<div class="button-grid" style="margin-bottom: 60px;">
    <div class="vr-button" id="calibrate">
        <div class="vr-button-label">CAL</div>
    </div>
</div>
<div class="cube-container">
    <div class="cube" id="cube">
        <div class="cube-face front">F</div>
        <div class="cube-face back">B</div>
        <div class="cube-face left">L</div>
        <div class="cube-face right">R</div>
        <div class="cube-face top">T</div>
        <div class="cube-face bottom">B</div>
    </div>
</div>

<div class="joystick-container">
    <div class="joystick-area">
        <div class="joystick-thumb" id="joystick"></div>
    </div>
    <div class="trigger upper-trigger" id="upperTrigger">
        <div class="trigger-label">Upper</div>
    </div>
    <div class="trigger lower-trigger" id="lowerTrigger">
        <div class="trigger-label">Lower</div>
    </div>
</div>

<div class="button-grid">
    {% if hand == 'Right' %}
    <div class="vr-button" id="system">
        <div class="vr-button-label">SYS</div>
    </div>
    <div class="vr-button" id="B">
        <div class="vr-button-label">B</div>
    </div>
    <div class="vr-button" id="A">
        <div class="vr-button-label">A</div>
    </div>
    {% else %}
    <div class="vr-button" id="X">
        <div class="vr-button-label">X</div>
    </div>
    <div class="vr-button" id="Y">
        <div class="vr-button-label">Y</div>
    </div>
    <div class="vr-button" id="system">
        <div class="vr-button-label">SYS</div>
    </div>
    {% endif %}
</div>

<script>
    const CONFIG = {
        hand: "{{ hand }}",
        sendInterval: "{{ send_interval }}",
        deadZone: 0.05
    };

    const serverIp = "{{ server_ip }}";
    const serverPort="{{ server_port }}"
    const websocketUrl = `ws://${serverIp}:${serverPort}`;

    const socket = new WebSocket(websocketUrl);

    socket.onopen = function() {
        console.log('WebSocket connection established');
    };

    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        console.log('Message received:', data);
    };

    socket.onclose = function() {
        console.log('WebSocket connection closed');
    };

    socket.onerror = function(error) {
        console.error('WebSocket error:', error);
    };

    let state = {
        alpha: 0,
        beta: 0,
        gamma: 0,
        joystick: [0, 0],
        joystickClicked: false,
        buttons: {
            system: false,
            A: false,
            B: false,
            X: false,
            Y: false,
            upperTrigger: false,
            lowerTrigger: false
        }
    };

    let rawQuaternion = { w: 1, x: 0, y: 0, z: 0 };
    let calibQuaternion = { w: 1, x: 0, y: 0, z: 0 };
    let calibratedQuaternion = { w: 1, x: 0, y: 0, z: 0 };

    const cube = document.getElementById('cube');

    initJoystick();
    initButtons();
    initTriggers();
    initCalibrate();
    startTracking();

    function startTracking() {
        window.addEventListener('deviceorientation', event => {
            rawQuaternion = toQuaternion(event.alpha || 0, event.beta || 0, event.gamma || 0);
            calibratedQuaternion = multiplyQuaternions(calibQuaternion, rawQuaternion);
            updateCubeRotation(calibratedQuaternion);
        });

        setInterval(() => {
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    hand: CONFIG.hand,
                    quaternion: calibratedQuaternion,
                    ...state
                }));
            }
        }, CONFIG.sendInterval);
    }

    function updateCubeRotation(quaternion) {
        const matrix = quaternionToMatrix(quaternion);
        cube.style.transform = `matrix3d(${matrix.join(',')})`;
    }

    function toQuaternion(alpha, beta, gamma) {
        const degToRad = Math.PI / 180;

        const angles = {
            z: -alpha * degToRad,
            x: -beta * degToRad,
            y: gamma * degToRad
        };

        const cz = Math.cos(angles.z / 2);
        const sz = Math.sin(angles.z / 2);
        const cx = Math.cos(angles.x / 2);
        const sx = Math.sin(angles.x / 2);
        const cy = Math.cos(angles.y / 2);
        const sy = Math.sin(angles.y / 2);

        const qz = { w: cz, x: 0, y: 0, z: sz };
        const qx = { w: cx, x: sx, y: 0, z: 0 };
        const qy = { w: cy, x: 0, y: sy, z: 0 };

        const temp = multiplyQuaternions(qz, qx);
        return multiplyQuaternions(temp, qy);
    }

    function multiplyQuaternions(a, b) {
        return {
            w: a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z,
            x: a.w * b.x + a.x * b.w + a.y * b.z - a.z * b.y,
            y: a.w * b.y - a.x * b.z + a.y * b.w + a.z * b.x,
            z: a.w * b.z + a.x * b.y - a.y * b.x + a.z * b.w
        };
    }

    function quaternionToMatrix(q) {
        const { x, y, z, w } = q;
        const xx = x * x, xy = x * y, xz = x * z, xw = x * w;
        const yy = y * y, yz = y * z, yw = y * w;
        const zz = z * z, zw = z * w;

        return [
            1 - 2 * (yy + zz), 2 * (xy - zw), 2 * (xz + yw), 0,
            2 * (xy + zw), 1 - 2 * (xx + zz), 2 * (yz - xw), 0,
            2 * (xz - yw), 2 * (yz + xw), 1 - 2 * (xx + yy), 0,
            0, 0, 0, 1
        ];
    }

    function initJoystick() {
        const joystick = document.getElementById('joystick');
        const area = document.querySelector('.joystick-area');
        let touchId = null;

        const updatePosition = (x, y) => {
            const distance = Math.sqrt(x * x + y * y);
            if (distance > 1) {
                x /= distance;
                y /= distance;
            }
            state.joystick = [
                Math.abs(x) > CONFIG.deadZone ? x : 0,
                Math.abs(y) > CONFIG.deadZone ? y : 0
            ];
            joystick.style.transform = `translate(${x * 200}%, ${y * 200}%) translate(-50%, -50%)`;
        };

        area.addEventListener('touchstart', e => {
            if (!touchId) {
                touchId = e.changedTouches[0].identifier;
                updateJoystick(e);
            }
        });

        area.addEventListener('touchmove', e => {
            if (touchId !== null) {
                updateJoystick(e);
            }
        });

        area.addEventListener('touchend', () => {
            touchId = null;
            joystick.style.transform = 'translate(-50%, -50%)';
            state.joystick = [0, 0];
        });

        joystick.addEventListener('dblclick', () => {
            state.joystickClicked = !state.joystickClicked;

            if (state.joystickClicked) {
                joystick.classList.add('active');
            } else {
                joystick.classList.remove('active');
            }

            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    hand: CONFIG.hand,
                    joystickClicked: state.joystickClicked
                }));
            }
        });

        function updateJoystick(e) {
            const touch = Array.from(e.touches).find(t => t.identifier === touchId);
            if (!touch) return;
            const rect = area.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const x = (touch.clientX - rect.left - centerX) / centerX;
            const y = (touch.clientY - rect.top - centerY) / centerY;
            updatePosition(x, y);
        }
    }

    function initButtons() {
        document.querySelectorAll('.vr-button').forEach(btn => {
            btn.addEventListener('touchstart', () => {
                btn.classList.add('active');
                state.buttons[btn.id] = true;
            });

            btn.addEventListener('touchend', () => {
                btn.classList.remove('active');
                state.buttons[btn.id] = false;
            });
        });
    }

    function initTriggers() {
        const initTrigger = (id, stateKey) => {
            const trigger = document.getElementById(id);
            trigger.addEventListener('touchstart', () => {
                trigger.classList.add('active');
                state.buttons[stateKey] = true;
            });

            trigger.addEventListener('touchend', () => {
                trigger.classList.remove('active');
                state.buttons[stateKey] = false;
            });
        };

        initTrigger('upperTrigger', 'upperTrigger');
        initTrigger('lowerTrigger', 'lowerTrigger');
    }

    function initCalibrate() {
        document.getElementById('calibrate').addEventListener('click', () => {
            calibQuaternion = {
                w: rawQuaternion.w,
                x: -rawQuaternion.x,
                y: -rawQuaternion.y,
                z: -rawQuaternion.z
            };

            // 定义用于 Y 轴 -90 度旋转的四元数
            const NinetyDegreesXQuaternion = {
                w: Math.cos(Math.PI / 4),
                x: Math.sin(Math.PI / 4),
                y: 0,
                z: 0
            };

            // 将校准四元数与额外的 -90 度旋转四元数相乘
            calibQuaternion = multiplyQuaternions(NinetyDegreesXQuaternion, calibQuaternion);

            console.log('Calibration applied');
        });
    }
</script>
</body>
</html>
